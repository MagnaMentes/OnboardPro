# Smart Scheduler в OnboardPro

## Обзор

Smart Scheduler - модуль для умного планирования шагов онбординга в OnboardPro. Основная цель - расчет дедлайнов для шагов программы онбординга с учетом рабочих дней, выходных и праздников.

## Возможности

- Автоматический расчет дедлайнов шагов при назначении программы
- Учет рабочих, выходных и праздничных дней
- Последовательное планирование обязательных шагов
- Поддержка параллельного выполнения необязательных шагов
- Автоматические напоминания о приближающихся дедлайнах
- Уведомления о просроченных дедлайнах для HR и менеджеров

## Структура данных

Smart Scheduler расширяет модель `UserStepProgress` следующими полями:

- `planned_date_start` - запланированная дата начала шага
- `planned_date_end` - запланированная дата окончания (дедлайн)
- `actual_completed_at` - фактическая дата выполнения шага

## Алгоритм работы

### Расчет дедлайнов

1. Для каждого шага программы, при назначении:

   - Устанавливается `planned_date_start` (начальная дата)
   - Рассчитывается `planned_date_end` с учетом рабочих дней:
     - Прибавляется `deadline_days` шага
     - Исключаются выходные (суббота, воскресенье)
     - Исключаются праздники (при наличии данных)

2. Распределение шагов по времени:
   - Обязательные шаги (`is_required=True`) планируются последовательно
   - Необязательные шаги могут выполняться параллельно с предыдущими шагами

### Система напоминаний

- За 24 часа до дедлайна - уведомление пользователю
- При пропуске дедлайна - уведомление HR и менеджерам

## Класс SmartSchedulerService

Основной сервисный класс, реализующий логику планирования.

### Методы

- `is_weekend(date)` - проверяет, является ли день выходным
- `is_holiday(date)` - проверяет, является ли день праздничным
- `is_working_day(date)` - проверяет, является ли день рабочим
- `add_working_days(start_date, days_to_add)` - добавляет указанное количество рабочих дней к дате
- `schedule_steps(assignment)` - распределяет шаги для конкретного назначения
- `schedule_assignment(assignment_id)` - планирует шаги по ID назначения

## Интеграция с уведомлениями

Smart Scheduler интегрирован с системой уведомлений:

1. Функция `check_approaching_deadlines()` в модуле `notifications.signals` обновлена для работы с новыми полями
2. Система генерирует два типа уведомлений:
   - `NotificationType.DEADLINE` - для напоминаний о приближающихся дедлайнах
   - `NotificationType.WARNING` - для уведомлений о пропущенных дедлайнах

## Расширение системы

В будущем планируются следующие расширения:

- Интеграция с Google Calendar и другими календарными сервисами
- Учет персональных графиков сотрудников (выходные, отпуска)
- Учет загруженности сотрудников при планировании шагов
