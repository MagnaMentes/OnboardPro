# Solomia Chat - Backend Documentation

## Обзор

Solomia Chat - это интерактивный AI-чат, интегрированный в платформу OnboardPro. Он позволяет пользователям общаться с AI-ассистентом в контексте конкретных шагов онбординга. Чат сохраняет историю сообщений для каждого шага, что позволяет обеспечить персонализированную поддержку и помощь сотрудникам на протяжении всего процесса онбординга.

## Модели данных

### AIChatMessage

Модель для хранения сообщений чата между пользователем и AI-ассистентом.

**Поля:**

- `user` (ForeignKey → User): Пользователь, отправивший сообщение или получивший ответ
- `role` (CharField): Роль в чате - 'human' или 'assistant'
- `message` (TextField): Текст сообщения
- `step_progress` (ForeignKey → UserStepProgress): Связанный с сообщением шаг онбординга (опционально)
- `created_at` (DateTimeField): Дата и время создания сообщения

**Индексы:**

- [user, step_progress]: Для быстрого поиска сообщений для конкретного пользователя и шага
- [created_at]: Для сортировки сообщений по времени

## Сервисы

### SolomiaChatService

Сервис для обработки сообщений чата и генерации ответов от AI-ассистента Solomia.

**Методы:**

#### generate_reply(user_id, step_id, message)

Генерирует ответ от AI на основе сообщения пользователя и сохраняет историю.

**Параметры:**

- `user_id`: ID пользователя
- `step_id`: ID шага (UserStepProgress)
- `message`: Текст сообщения от пользователя

**Возвращает:**

- Сгенерированный ответ от AI

**Процесс:**

1. Получает информацию о шаге
2. Сохраняет сообщение пользователя
3. Получает историю чата для контекста
4. Генерирует ответ (в текущей версии - заглушка)
5. Сохраняет ответ AI
6. Возвращает сгенерированный ответ

#### get_chat_history(user_id, step_id, limit=None)

Получает историю чата для указанного пользователя и шага.

**Параметры:**

- `user_id`: ID пользователя
- `step_id`: ID шага (UserStepProgress)
- `limit`: Ограничение количества сообщений (опционально)

**Возвращает:**

- Список сообщений чата

## API Endpoints

### GET /api/solomia/chat/{step_id}/

Получить историю сообщений чата для указанного шага.

**Параметры URL:**

- `step_id`: ID шага

**Ответ:**

```json
{
  "messages": [
    {
      "id": 1,
      "role": "human",
      "message": "Как мне лучше подготовиться к этой встрече?",
      "created_at": "2025-05-22T14:30:00Z"
    },
    {
      "id": 2,
      "role": "assistant",
      "message": "Для эффективной подготовки к встрече рекомендую сначала изучить...",
      "created_at": "2025-05-22T14:30:05Z"
    }
  ]
}
```

### POST /api/solomia/chat/{step_id}/

Отправить новое сообщение и получить ответ от AI.

**Параметры URL:**

- `step_id`: ID шага

**Тело запроса:**

```json
{
  "message": "Как мне лучше подготовиться к этой встрече?"
}
```

**Ответ:**

```json
{
  "messages": [
    {
      "id": 3,
      "role": "human",
      "message": "Как мне лучше подготовиться к этой встрече?",
      "created_at": "2025-05-22T14:35:00Z"
    },
    {
      "id": 4,
      "role": "assistant",
      "message": "Для эффективной подготовки к встрече рекомендую сначала изучить...",
      "created_at": "2025-05-22T14:35:05Z"
    }
  ]
}
```

## Ограничения доступа

- Доступ к чату имеет только пользователь, которому назначен шаг
- API использует аутентификацию через JWT-токены
